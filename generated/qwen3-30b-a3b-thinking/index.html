<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>タスク管理アプリ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      color: #333;
      background-color: #fff;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    main {
      max-width: 800px;
      margin: 0 auto;
    }
    form {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    form input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      flex: 1;
    }
    form button {
      background: #fff;
      border: 1px solid #333;
      padding: 8px 16px;
      cursor: pointer;
    }
    .task-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .task-item {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .task-content {
      flex: 1;
      margin-right: 10px;
    }
    .task-status {
      background: #f0f0f0;
      padding: 2px 5px;
      border-radius: 3px;
      margin-right: 10px;
    }
    .task-created, .task-due, .task-completed {
      margin-right: 10px;
      font-size: 0.85em;
    }
    button {
      background: none;
      border: none;
      cursor: pointer;
      color: #333;
      padding: 5px;
    }
    button:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <h1>タスク管理</h1>
  </header>
  <main>
    <form id="task-form">
      <input type="text" id="task-content" placeholder="タスクを入力" required>
      <input type="date" id="task-due-date">
      <button type="submit">追加</button>
    </form>
    <div id="task-list">
      <!-- Tasks will be listed here -->
    </div>
  </main>
  <script>
    let db;
    const DB_NAME = 'qwen3-30b-a3b-thinking-taskdb';
    const DB_VERSION = 1;
    const STORE_NAME = 'tasks';

    function formatDate(dateString) {
      if (!dateString) return '';
      return new Date(dateString).toISOString().split('T')[0];
    }

    function initDB() {
      const request = indexedDB.open(DB_NAME, DB_VERSION);

      request.onupgradeneeded = function(event) {
        db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
          store.createIndex('completed', 'completed', { unique: false });
        }
      };

      request.onsuccess = function(event) {
        db = event.target.result;
        renderTasks();
      };

      request.onerror = function(event) {
        console.error('IndexedDB error:', event.target.error);
      };
    }

    function getTasks() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();

        request.onsuccess = function(event) {
          resolve(event.target.result);
        };

        request.onerror = function(event) {
          reject(event.target.error);
        };
      });
    }

    function addTask(content, dueDate) {
      return new Promise((resolve, reject) => {
        const now = new Date().toISOString();
        const task = {
          content,
          completed: false,
          createdAt: now,
          dueDate,
          completedAt: null
        };

        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.add(task);

        request.onsuccess = function(event) {
          resolve(event.target.result);
        };

        request.onerror = function(event) {
          reject(event.target.error);
        };
      });
    }

    function updateTask(id, completed) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);

        request.onsuccess = function(event) {
          const task = event.target.result;
          task.completed = completed;
          task.completedAt = completed ? new Date().toISOString() : null;

          const updateRequest = store.put(task);

          updateRequest.onsuccess = function() {
            resolve();
          };

          updateRequest.onerror = function() {
            reject(updateRequest.error);
          };
        };

        request.onerror = function() {
          reject(request.error);
        };
      });
    }

    function deleteTask(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);

        request.onsuccess = function() {
          resolve();
        };

        request.onerror = function() {
          reject(request.error);
        };
      });
    }

    function renderTasks() {
      getTasks().then(tasks => {
        const taskList = document.getElementById('task-list');
        taskList.innerHTML = '';

        tasks.forEach(task => {
          const taskItem = document.createElement('div');
          taskItem.className = 'task-item';

          const statusText = task.completed ? '完了' : '未完了';
          const statusClass = task.completed ? 'task-status completed' : 'task-status';

          taskItem.innerHTML = `
            <span class="task-content">${task.content}</span>
            <span class="${statusClass}">${statusText}</span>
            <span class="task-created">登録日: ${formatDate(task.createdAt)}</span>
            <span class="task-due">期限: ${task.dueDate}</span>
            <span class="task-completed">完了日: ${task.completed ? formatDate(task.completedAt) : '-'}</span>
            <button class="complete-btn" data-id="${task.id}">${task.completed ? '未完了' : '完了'}</button>
            <button class="delete-btn" data-id="${task.id}">削除</button>
          `;

          taskList.appendChild(taskItem);
        });

        document.querySelectorAll('.complete-btn').forEach(button => {
          button.addEventListener('click', () => {
            const id = parseInt(button.dataset.id);
            const isCompleted = button.textContent === '完了';
            updateTask(id, !isCompleted).then(() => {
              renderTasks();
            });
          });
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
          button.addEventListener('click', () => {
            const id = parseInt(button.dataset.id);
            deleteTask(id).then(() => {
              renderTasks();
            });
          });
        });
      }).catch(err => {
        console.error('Failed to render tasks:', err);
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      initDB();

      document.getElementById('task-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const content = document.getElementById('task-content').value;
        const dueDate = document.getElementById('task-due-date').value;
        addTask(content, dueDate).then(() => {
          document.getElementById('task-form').reset();
          renderTasks();
        }).catch(err => {
          console.error('Failed to add task:', err);
        });
      });
    });
  </script>
</body>
</html>
